<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4 - Vision, convolutions, recurrence &mdash; ANCM 2025 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Project Inspiration" href="../project_ideas.html" />
    <link rel="prev" title="3 - Item Response Theory with Stan" href="../week_3/3_IRT_Stan.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ANCM 2025
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Week 1:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../week_1/1_Logistic_regression_for_musical_tags.html">1 - Logistic Regression for Musical Tags</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Week 2:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../week_2/2A_Language_Model_Refresher.html">2A - Language model refresher</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week_2/2B_RSA_with_fMRI_Data.html">2B - Representational Similarity with Story Reading fMRI data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week_2/2C_LM_Surprisal_and_EEG_data.html">2C - Language Model Surprisal and EEG Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Week 3:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../week_3/3_IRT_Stan.html">3 - Item Response Theory with Stan</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Week 4:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">4 - Vision, convolutions, recurrence</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Background">Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Dataset">Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Introduce-environment-clutter">Introduce environment clutter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#QUESTION-1"><strong>QUESTION 1</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#RNN-architecture">RNN architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Import-network-architecture">Import network architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Download-and-load-pretrained-weights">Download and load pretrained weights</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Running-the-Model">Running the Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#QUESTION-2"><strong>QUESTION 2</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Recurrent-connections">Recurrent connections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#QUESTION-3"><strong>QUESTION 3</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Studying-category-orthogonal-information-flow">Studying category-orthogonal information flow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#QUESTION-4"><strong>QUESTION 4</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#QUESTION-5"><strong>QUESTION 5</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Perturbation-analysis">Perturbation analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#QUESTION-6"><strong>QUESTION 6</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#QUESTION-7"><strong>QUESTION 7</strong></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Inspiration:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../project_ideas.html">Project Inspiration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ANCM 2025</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">4 - Vision, convolutions, recurrence</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/week_4/4_Vision,_Convolutions_and_Recurrence.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="4---Vision,-convolutions,-recurrence">
<h1>4 - Vision, convolutions, recurrence<a class="headerlink" href="#4---Vision,-convolutions,-recurrence" title="Link to this heading"></a></h1>
<p><a class="reference external" href="https://github.com/annabavaresco/ancm2025/blob/main/docs/week_4/4_Vision,_Convolutions_and_Recurrence.ipynb"><img alt="View filled on Github" src="https://img.shields.io/static/v1.svg?logo=github&amp;label=Repo&amp;message=View%20On%20Github&amp;color=lightgrey" /></a> <a class="reference external" href="https://colab.research.google.com/github/annabavaresco/ancm2025/blob/main/docs/week_4/4_Vision,_Convolutions_and_Recurrence.ipynb"><img alt="View filled in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<p><em>By Clemens Bartnik &amp; Amber Brands (June 2022) with edits by Jelle Zuidema (September 2022) and Anna Bavaresco (July 2024). Much of the code has been taken from the Kietzmann Lab’s</em> <a class="reference external" href="https://github.com/KietzmannLab/svrhm21_RNN_explain.git">Github</a>.</p>
<hr class="docutils" />
<p>In this lab, we explore information processing in a pretrained recurrent neural network (RNN) trained for object recognition from visual input and investigate the role of a <em>recurrent</em> information flow.</p>
<p>We focus on a neural network model that uses both convolutions (as in the convolutional neural nets we saw for audio and image processing) and recurrent connections (i.e., connection that break the feedforward structure we are used to in these models).</p>
<p>This lab is based on the paper <a class="reference external" href="https://doi.org/10.48550/arXiv.2111.07898">Category-orthogonal object features guide information processing in recurrent neural networks trained for object categorization</a>. It might be useful for you to open the paper in parallel to this notebook, since it offers background information as well as additional info on methods and analysis.</p>
<p><strong>Learning goals of this tutorial</strong>:</p>
<ul class="simple">
<li><p>See how datasets such as MNIST can be adapted to better understand how models perform object recognition</p></li>
<li><p>Get insights in how we can use lateral and top-down connections to incorporate recurrent information in models</p></li>
<li><p>Study the role of category-orthogonal variables in solving object recognition</p></li>
<li><p>Understand which research questions can be investigated with decoding methods and which require causal manipulations.</p></li>
</ul>
<p><img alt="Figure 1" src="https://github.com/clclab/ANCM/blob/main/book/img/04_lab_paper_figure1.png?raw=1" /></p>
<section id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Link to this heading"></a></h2>
<p>Let’s import some useful packages.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># install packages</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.interpolation</span> <span class="kn">import</span> <span class="n">zoom</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.interpolation</span> <span class="kn">import</span> <span class="n">rotate</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>

<span class="c1"># import MNIST and fashion MNIST datasets</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">mnist</span> <span class="k">as</span> <span class="n">mnist_plot</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">fashion_mnist</span> <span class="k">as</span> <span class="n">fashion_mnist_plot</span>

<span class="c1"># import pytroch</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.sampler</span> <span class="kn">import</span> <span class="n">SubsetRandomSampler</span>
<span class="kn">from</span> <span class="nn">torchsummary</span> <span class="kn">import</span> <span class="n">summary</span>

<span class="c1"># suppress warnings for visibility</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># This command makes sure that the figure is plotted in the notebook instead of in a separate window!</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipython-input-3012441900.py:10: DeprecationWarning: Please import `zoom` from the `scipy.ndimage` namespace; the `scipy.ndimage.interpolation` namespace is deprecated and will be removed in SciPy 2.0.0.
  from scipy.ndimage.interpolation import zoom
/tmp/ipython-input-3012441900.py:11: DeprecationWarning: Please import `rotate` from the `scipy.ndimage` namespace; the `scipy.ndimage.interpolation` namespace is deprecated and will be removed in SciPy 2.0.0.
  from scipy.ndimage.interpolation import rotate
</pre></div></div>
</div>
<p>Now clone this <a class="reference external" href="https://github.com/KietzmannLab/svrhm21_RNN_explain.git">Github</a> repository to the Colab Environment:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">capture</span>
<span class="err">!</span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">KietzmannLab</span><span class="o">/</span><span class="n">svrhm21_RNN_explain</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
</div>
</section>
<section id="Background">
<h2>Background<a class="headerlink" href="#Background" title="Link to this heading"></a></h2>
<p>Humans are able to recognize objects even when there is occlusion or clutter present in the image. As you can experience in the famous Gestalt figure below, humans perceive this image as if there is a white triangle lying over black dots and another black triangle — even though there are no triangles.</p>
<p><img alt="Triangle" src="https://github.com/clclab/ANCM/blob/main/book/img/04_lab_triangle.jpeg?raw=1" /></p>
<p><a class="reference external" href="https://miro.medium.com/max/2000/0*NnBMMDYOlNXHJYCw.png">source</a></p>
<p>This is because humans tend to group parts of the images, so that we perceive coherent, global shapes. It has been argued that <em>recurrence</em> in the neural substrate responsible for visual processing may underlie computations that benefit task performance by making use of these contextual signals (<a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0896627307007623">Roelfsema et al., 2007</a>; <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0959438820301768">van Bergen &amp; Kriegeskorte,
2020</a>).</p>
<p>Feedforward Neural Networks (FNN) have been widely used to solve object recognition. However, Recurrent Neural Networks (RNN) — already popular for decades in language processing — have been recently been introduced into the domain of visual processing to help solve common problems of FNN approaches and to model information that humans seem to use when categorizing objects. They achieve this by incorporating recurrent activity. In other words, the unit activations are a fuction both of the
input and their prior activations. It is, however, still unclear whether category orthogonal information (such as objects location, orientation or scale) is discarded or used by RNNs as auxillary information during object recognition. Looking at the image above suggests that these auxillary information can indeed be very important for object categorization.</p>
<p>The authors of our considered paper try to shed light onto the role of auxiliary information. They do this by training and testing multiple instances of an RNN on an object categorization task while presenting target objects in cluttered environments. To investigate the inner workings of these models and to characterize the information related to auxiliary variables, they utilize diagnostic read-outs (<em>probes</em> or <em>diagnostic classifiers</em>) across layers and time.</p>
<p>In this lab, you will first replicate the process of generating the stimuli, followed by instantiating the networks. The core of the lab assignment is then to replicate some the main findings from the key paper, and to interpret the results.</p>
</section>
<section id="Dataset">
<h2>Dataset<a class="headerlink" href="#Dataset" title="Link to this heading"></a></h2>
<p>Let’s start with visualizing some of the images contained in the vanilla versions of the <a class="reference external" href="https://www.tensorflow.org/datasets/catalog/mnist">MNIST</a> and <a class="reference external" href="https://github.com/zalandoresearch/fashion-mnist">Fashion-MNIST (FMNIST)</a> datasets: Both datasets contain 10 image classes consisting of either a single digit number or a clothing item, respectively.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Custom Dataset</span>

<span class="k">def</span> <span class="nf">ensure_unzipped</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="n">unzipped_path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">unzipped_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unzipped_path</span>

    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">unzipped_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">unzipped_path</span>


<span class="k">class</span> <span class="nc">OurDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images_path</span><span class="p">,</span> <span class="n">labels_path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>

        <span class="n">images_path</span> <span class="o">=</span> <span class="n">ensure_unzipped</span><span class="p">(</span><span class="n">images_path</span><span class="p">)</span>
        <span class="n">labels_path</span> <span class="o">=</span> <span class="n">ensure_unzipped</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

        <span class="c1"># Load images</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">images_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">num_images</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span> <span class="s2">&quot;big&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">],</span> <span class="s2">&quot;big&quot;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span> <span class="s2">&quot;big&quot;</span><span class="p">)</span>

        <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>

        <span class="c1"># Load labels</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="c1"># Convert to tensor BEFORE indexing</span>
        <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">raw_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>

        <span class="c1">#  Convert to one-hot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_labels</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_labels</span><span class="p">)),</span> <span class="n">raw_labels</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, 28, 28)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># load datasets</span>

<span class="n">mnist_train</span> <span class="o">=</span> <span class="n">OurDataset</span><span class="p">(</span>
    <span class="s2">&quot;/content/svrhm21_RNN_explain/MNIST_data/train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/content/svrhm21_RNN_explain/MNIST_data/train-labels-idx1-ubyte.gz&quot;</span>
<span class="p">)</span>
<span class="n">mnist_test</span> <span class="o">=</span> <span class="n">OurDataset</span><span class="p">(</span>
    <span class="s2">&quot;/content/svrhm21_RNN_explain/MNIST_data/t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/content/svrhm21_RNN_explain/MNIST_data/t10k-labels-idx1-ubyte.gz&quot;</span>
<span class="p">)</span>

<span class="n">fmnist_train</span> <span class="o">=</span> <span class="n">OurDataset</span><span class="p">(</span>
    <span class="s2">&quot;/content/svrhm21_RNN_explain/fMNIST_data/train-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/content/svrhm21_RNN_explain/fMNIST_data/train-labels-idx1-ubyte.gz&quot;</span>
<span class="p">)</span>
<span class="n">fmnist_test</span> <span class="o">=</span> <span class="n">OurDataset</span><span class="p">(</span>
    <span class="s2">&quot;/content/svrhm21_RNN_explain/fMNIST_data/t10k-images-idx3-ubyte.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/content/svrhm21_RNN_explain/fMNIST_data/t10k-labels-idx1-ubyte.gz&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># define labels</span>
<span class="n">mnist_class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">]</span>
<span class="n">fmnist_class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T-shirt/top&#39;</span><span class="p">,</span> <span class="s1">&#39;Trouser&#39;</span><span class="p">,</span> <span class="s1">&#39;Pullover&#39;</span><span class="p">,</span> <span class="s1">&#39;Dress&#39;</span><span class="p">,</span> <span class="s1">&#39;Coat&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Sandal&#39;</span><span class="p">,</span> <span class="s1">&#39;Shirt&#39;</span><span class="p">,</span> <span class="s1">&#39;Sneaker&#39;</span><span class="p">,</span> <span class="s1">&#39;Bag&#39;</span><span class="p">,</span> <span class="s1">&#39;Ankle boot&#39;</span><span class="p">]</span>

<span class="n">class_names</span> <span class="o">=</span> <span class="n">mnist_class_names</span> <span class="o">+</span> <span class="n">fmnist_class_names</span>
</pre></div>
</div>
</div>
<p>This code will create a nice plot where you can see examples from the two datasets.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># initiate plot</span>
<span class="n">ncolumns</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncolumns</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># count images</span>
<span class="n">mnist_img_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mnist_train</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
<span class="n">fmnist_img_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fmnist_train</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>

<span class="c1"># plot example images</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncolumns</span><span class="p">):</span> <span class="c1"># columns</span>

    <span class="c1"># choose random index and plot mnist example</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mnist_img_count</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">mnist_train</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># choose random index and plot fmnist example</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fmnist_img_count</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">fmnist_train</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MNIST&#39;</span><span class="p">)</span>
      <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;fashion MNIST&#39;</span><span class="p">)</span>

<span class="c1"># show plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_16_0.png" src="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_16_0.png" />
</div>
</div>
</section>
<section id="Introduce-environment-clutter">
<h2>Introduce environment clutter<a class="headerlink" href="#Introduce-environment-clutter" title="Link to this heading"></a></h2>
<p>As you could see, the images from both datasets are not naturalistic, which makes classification easier for a number of reasons; for one, the objects are always fully visible (i.e., not occluded by adjacent objects).</p>
<p>To be able to effectively study the effect of recurrent information flow, it is useful to consider a more challenging setup. The authors created it by manipulating the images in two ways:</p>
<ol class="arabic simple">
<li><p>By adding structured clutter, i.e., randomly sampled fragments of other objects in the dataset;</p></li>
<li><p>By altering the objects along three dimensions, i.e., location, orientation, and scale.</p></li>
</ol>
<p>The functions in the next block alter the initial MNIST and fashion MNIST images as described above. You are not expected to understand every line of the functions. It is more useful to try to understand what they are doing by observing the images they output.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Helper functions</span>

<span class="c1"># A function to scramble image chunks</span>
<span class="k">def</span> <span class="nf">scramble_images</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">parts_h</span><span class="p">):</span> <span class="c1"># scramble parts_h*parts_h equal parts of the given image</span>
    <span class="n">win_prop</span> <span class="o">=</span> <span class="n">parts_h</span>
    <span class="n">dimsh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">im_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dimsh</span><span class="p">)</span>
    <span class="n">dimsh_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">dimsh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">win_prop</span><span class="p">)</span>
    <span class="n">n_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dimsh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">dimsh_win</span><span class="p">))</span>
    <span class="n">cell_c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dimsh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">dimsh_win</span><span class="p">)</span>
    <span class="n">ind_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_cells</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n_cells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ind_new</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_cells</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n_cells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">ind_new</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cells</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">ind_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">im_new</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">cell_c</span><span class="p">)</span><span class="o">*</span><span class="n">dimsh_win</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">cell_c</span><span class="p">)</span><span class="o">*</span><span class="n">dimsh_win</span><span class="o">+</span><span class="n">dimsh_win</span><span class="p">),</span>
               <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="n">cell_c</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">dimsh_win</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="n">cell_c</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">dimsh_win</span><span class="o">+</span><span class="n">dimsh_win</span><span class="p">)]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">cell_c</span><span class="p">)</span><span class="o">*</span><span class="n">dimsh_win</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">cell_c</span><span class="p">)</span><span class="o">*</span><span class="n">dimsh_win</span><span class="o">+</span><span class="n">dimsh_win</span><span class="p">),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="n">cell_c</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">dimsh_win</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="n">cell_c</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">dimsh_win</span><span class="o">+</span><span class="n">dimsh_win</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">im_new</span>

<span class="c1"># A function to generate images and the respective labels for training and testing</span>
<span class="k">def</span> <span class="nf">generate_images</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">,</span><span class="n">n_set</span><span class="p">):</span> <span class="c1"># n_imgs required, set used (0 train, 1 val, 2 test) 8 objects in image (1 is intact), 2 levels of zoom, rotation and x/y pos for each object</span>
    <span class="n">imgs_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_imgs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
    <span class="n">imgs_h1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_imgs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
    <span class="n">labs_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_imgs</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span>
    <span class="n">pos_x_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_imgs</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">pos_y_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_imgs</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">size_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_imgs</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">rot_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_imgs</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">n_objs</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">for</span> <span class="n">n_im</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">):</span>
        <span class="n">inst_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
        <span class="n">inst_img1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
        <span class="n">obj_ord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_objs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n_objs</span><span class="p">)</span>
        <span class="n">dum_obj_ind</span> <span class="o">=</span> <span class="mi">4</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">n_objs</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dum_dat_ord</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">1.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_objs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dum_dat_ord</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># dataset M or F</span>
                <span class="k">if</span> <span class="n">n_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dathh</span> <span class="o">=</span> <span class="n">mnist_train</span>
                <span class="k">elif</span> <span class="n">n_set</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dathh</span> <span class="o">=</span> <span class="n">mnist_test</span>
                <span class="c1"># elif n_set == 2:</span>
                <span class="c1">#     dathh = mnist.test</span>
                <span class="n">inst_obj_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dathh</span><span class="o">.</span><span class="n">images</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                    <span class="n">inst_lab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dathh</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">inst_obj_ind</span><span class="p">,:]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">inst_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dathh</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">inst_obj_ind</span><span class="p">,:],(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dathh</span> <span class="o">=</span> <span class="n">fmnist_train</span>
                <span class="k">elif</span> <span class="n">n_set</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dathh</span> <span class="o">=</span> <span class="n">fmnist_test</span>
                <span class="c1"># elif n_set == 2:</span>
                <span class="c1">#     dathh = fmnist.test</span>
                <span class="n">inst_obj_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dathh</span><span class="o">.</span><span class="n">images</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                    <span class="n">inst_lab</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dathh</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">inst_obj_ind</span><span class="p">,:]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">inst_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dathh</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">inst_obj_ind</span><span class="p">,:],(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
            <span class="n">dumh111</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">dumh111</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># zoom 0.9 or 1.5</span>
                <span class="n">inst_obj</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">,</span><span class="mf">0.9</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span> <span class="c1"># zoom 0.8 to 1.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inst_obj</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">,</span><span class="mf">1.5</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span> <span class="c1"># zoom 1.4 to 1.6</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                <span class="n">size_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="n">dumh111</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">dumh111</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">dumh111</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># rotate 30 or -30</span>
                <span class="n">inst_obj</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">,</span><span class="mi">30</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># rotate 25 to 35</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inst_obj</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">,</span><span class="o">-</span><span class="mi">30</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># rotate -25 to -35</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                <span class="n">rot_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="n">dumh111</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                <span class="n">inst_obj</span> <span class="o">=</span> <span class="n">scramble_images</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># scrambled if not object of interest</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">obj_ord</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># x_loc up or down</span>
                <span class="n">x_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">25</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.5</span><span class="p">))</span> <span class="c1"># 25 +- 2.5</span>
                <span class="n">y_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">25</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.5</span><span class="p">))</span> <span class="c1"># 25 +- 2.5</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                    <span class="n">pos_y_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">pos_x_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">obj_ord</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">75</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.5</span><span class="p">))</span> <span class="c1"># 75 +- 2.5</span>
                <span class="n">y_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">25</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.5</span><span class="p">))</span> <span class="c1"># 25 +- 2.5</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                    <span class="n">pos_y_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">pos_x_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">obj_ord</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">x_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">25</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.5</span><span class="p">))</span> <span class="c1"># 25 +- 2.5</span>
                <span class="n">y_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">75</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.5</span><span class="p">))</span> <span class="c1"># 75 +- 2.5</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                    <span class="n">pos_y_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">pos_x_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">obj_ord</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">x_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">75</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.5</span><span class="p">))</span> <span class="c1"># 75 +- 2.5</span>
                <span class="n">y_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">75</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.5</span><span class="p">))</span> <span class="c1"># 75 +- 2.5</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                    <span class="n">pos_y_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">pos_x_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">inst_obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst_obj</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">))</span>
            <span class="c1"># print(int(np.floor(np.shape(inst_obj)[0]/2)),int(np.ceil(np.shape(inst_obj)[0]/2)),np.shape(inst_obj)[0])</span>
            <span class="n">inst_img</span><span class="p">[</span><span class="n">x_loc</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span><span class="n">x_loc</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)),</span><span class="n">y_loc</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span><span class="n">y_loc</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">inst_obj</span><span class="p">)</span><span class="o">*</span><span class="n">inst_img</span><span class="p">[</span><span class="n">x_loc</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span><span class="n">x_loc</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)),</span><span class="n">y_loc</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span><span class="n">y_loc</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))]</span> <span class="o">+</span> <span class="p">(</span><span class="n">inst_obj</span><span class="p">)</span><span class="o">*</span><span class="n">inst_obj</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dum_obj_ind</span><span class="p">:</span>
                <span class="n">inst_img1</span><span class="p">[</span><span class="n">x_loc</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span><span class="n">x_loc</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)),</span><span class="n">y_loc</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span><span class="n">y_loc</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">inst_obj</span><span class="p">)</span><span class="o">*</span><span class="n">inst_img1</span><span class="p">[</span><span class="n">x_loc</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span><span class="n">x_loc</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)),</span><span class="n">y_loc</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span><span class="n">y_loc</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inst_obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))]</span> <span class="o">+</span> <span class="p">(</span><span class="n">inst_obj</span><span class="p">)</span><span class="o">*</span><span class="n">inst_obj</span>
        <span class="n">inst_img</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst_img</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">inst_img</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">inst_img</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">inst_img</span><span class="p">))</span>
        <span class="n">inst_img1</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst_img1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">inst_img1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">inst_img1</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">inst_img1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">inst_img</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">inst_img1</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NaN in input&#39;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">imgs_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">inst_img</span>
        <span class="n">imgs_h1</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">inst_img1</span>
        <span class="n">labs_h</span><span class="p">[</span><span class="n">n_im</span><span class="p">,</span><span class="n">inst_lab</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">return</span> <span class="n">imgs_h</span><span class="p">,</span><span class="n">imgs_h1</span><span class="p">,</span><span class="n">labs_h</span><span class="p">,</span><span class="n">pos_x_h</span><span class="p">,</span><span class="n">pos_y_h</span><span class="p">,</span><span class="n">size_h</span><span class="p">,</span><span class="n">rot_h</span>
<br/></pre></div>
</div>
</div>
<p>Here, we run the function to corrupt images and then we plot some of the outputs to check how they look after ‘corruption’.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create cluttered images</span>
<span class="n">img_num</span> <span class="o">=</span> <span class="mi">12</span>        <span class="c1"># number of images to create</span>
<span class="n">img_set</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># set used (0 train, 1 test)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="c1"># create images</span>
<span class="n">inputs_v</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">labels_v</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">generate_images</span><span class="p">(</span><span class="n">img_num</span><span class="p">,</span> <span class="n">img_set</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># initiate plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># plot images</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>

    <span class="c1"># label</span>

    <span class="c1"># plot image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">inputs_v</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

    <span class="c1"># extract ground truth label</span>
    <span class="n">img_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">labels_v</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ground truth: </span><span class="si">{</span><span class="n">class_names</span><span class="p">[</span><span class="n">img_idx</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># increment count</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># show plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_21_0.png" src="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_21_0.png" />
</div>
</div>
<section id="QUESTION-1">
<h3><strong>QUESTION 1</strong><a class="headerlink" href="#QUESTION-1" title="Link to this heading"></a></h3>
<ol class="loweralpha simple">
<li><p>What happens to the cluttered generated images? Look at them carefully and briefly describe which are the key modifications with respect to the initial images.</p></li>
<li><p>Plot 4 images of the cluttered stimuli next to each other containing two pairs with the same ground truth labels (e.g., 2x ‘5’ and 2x ‘Sandal’).</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can write your code here</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="RNN-architecture">
<h2>RNN architecture<a class="headerlink" href="#RNN-architecture" title="Link to this heading"></a></h2>
<p>The RNN used for training and subsequent analyses consists of two convolutional layers followed by one fully connected (FC) layer, as illustrated in the paper below (Figure 2 in the paper). The architecture contained both lateral and top-down connections and the RNN was unrolled for 4 timesteps. Finally, the activations of the FC layer were concatenated and mapped to the classification output (i.e. <code class="docutils literal notranslate"><span class="pre">class_names</span></code>) using an FC layer.</p>
<p><img alt="Figure 2" src="https://github.com/clclab/ANCM/blob/main/book/img/04_lab_paper_figure2.png?raw=1" /></p>
<section id="Import-network-architecture">
<h3>Import network architecture<a class="headerlink" href="#Import-network-architecture" title="Link to this heading"></a></h3>
<p>Here we use the authors’ code from <a class="reference external" href="https://github.com/KietzmannLab/svrhm21_RNN_explain.git">Github</a> to instantiate their RNN implementation which incorporates both lateral and top-down connections. By clicking on the cell you can view their (very convluted) code to understand the implementation details (or not).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Defining the RNN class (click to see code)</span>

<span class="k">class</span> <span class="nc">RNNet_all_fbr</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_feats</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ker_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">t_steps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">b_flag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">g_flag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">l_flag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">t_flag</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
      <span class="c1"># b flag = bias modulation flag</span>
      <span class="c1"># g flag = gain modulation flag</span>
      <span class="c1"># l flag = lateral interactions flag</span>
      <span class="c1"># t flag = top-down interaction flag</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RNNet_all_fbr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># backbone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_feats</span><span class="p">,</span> <span class="n">ker_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,</span> <span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">ker_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">*</span> <span class="mi">9</span><span class="p">,</span> <span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="o">*</span><span class="n">t_steps</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="c1"># this corresponds to &quot;output&quot; in the drawing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># RECURRENT CONNECTIONS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1xb</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># in_channel, out_channel, kernel_size, stride, padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2xb</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1xb</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1c1b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,</span> <span class="n">n_feats</span><span class="p">,</span> <span class="n">ker_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2c1b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">n_feats</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1c1b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="mi">96</span><span class="o">*</span><span class="mi">96</span><span class="o">*</span><span class="n">n_feats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2c2b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">ker_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1c2b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="o">*</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1fc1b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1xg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># in_channel, out_channel, kernel_size, stride, padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2xg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1xg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1c1g</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,</span> <span class="n">n_feats</span><span class="p">,</span> <span class="n">ker_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2c1g</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">n_feats</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1c1g</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="mi">96</span><span class="o">*</span><span class="mi">96</span><span class="o">*</span><span class="n">n_feats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2c2g</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">ker_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1c2g</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="o">*</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1fc1g</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="n">n_feats</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span> <span class="o">=</span> <span class="n">n_feats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_steps</span> <span class="o">=</span> <span class="n">t_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_flag</span> <span class="o">=</span> <span class="n">b_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g_flag</span> <span class="o">=</span> <span class="n">g_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span> <span class="o">=</span> <span class="n">l_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span> <span class="o">=</span> <span class="n">t_flag</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1">#creating vectors for storing activations</span>
        <span class="n">actvs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#creating vectors for storing feedback activations</span>
        <span class="n">fb_acts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fb_acts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#creating vectors for storing combined feedback activations</span>
        <span class="n">fb_acts_comb</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fb_acts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">fb_acts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">*</span> <span class="mi">9</span><span class="p">)))</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1xb</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c2xb</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1xb</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1xg</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c2xg</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1xg</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="n">dumh000</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c1xb</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">])</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">c2xb</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">])</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1xb</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">))))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">g_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c1xg</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">])</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">c2xg</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">])</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1xg</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)))</span>
                <span class="n">actvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">dumh000</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">dumh000</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1c1b</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c2c1b</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1c1b</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">96</span><span class="p">)</span>
                <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1c1g</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c2c1g</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1c1g</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">96</span><span class="p">)</span>
                <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">b_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1c1b</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2c1b</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">])</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1c1b</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">96</span><span class="p">))))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">g_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1c1g</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2c1g</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="p">])</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1c1g</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">96</span><span class="p">))))</span>
                <span class="n">actvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c2c2b</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1c2b</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
                <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c2c2g</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1c2g</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
                <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">b_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c2c2b</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1c2b</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">g_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c2c2g</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">t_flag</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1c2g</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)))</span>
                <span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1fc1b</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
                <span class="n">fb_acts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1fc1g</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
                <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="n">fb_acts_comb</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_acts</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                <span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_feats</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">*</span> <span class="mi">9</span><span class="p">))</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">b_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1fc1b</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">g_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">l_flag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1fc1g</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="p">]))</span>
                <span class="n">actvs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">actvs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">actvs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">actvs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">actvs</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="mf">1e-10</span><span class="p">,</span><span class="mf">1.0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">actvs</span><span class="p">,</span> <span class="n">fb_acts</span><span class="p">,</span> <span class="n">fb_acts_comb</span>
</pre></div>
</div>
</div>
<p>Initialize the RNN using the hyperparameters used by the authors.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hyperparameters</span>
<span class="n">n_feats</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># in Conv layer 1</span>
<span class="n">ker_size</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># in Conv layer 1</span>
<span class="n">b_h</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># bias modulation flag</span>
<span class="n">g_h</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># gain modulation flag</span>
<span class="n">l_h</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># lateral interactions flag</span>
<span class="n">t_h</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># top-down interactions flag</span>

<span class="n">net_num</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">t_steps</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">net_save_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;rnn_bglt_0111_t_4_num_</span><span class="si">{</span><span class="n">net_num</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1">#+++str()+str()+&#39;_t_&#39;+str()+&#39;_num_&#39;+str()</span>

<span class="c1"># initialize RNN</span>
<span class="c1">#net = RNNet_all(n_feats,ker_size,t_steps,b_h,g_h,l_h,t_h)</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">RNNet_all_fbr</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,</span><span class="n">ker_size</span><span class="p">,</span><span class="n">t_steps</span><span class="p">,</span><span class="n">b_h</span><span class="p">,</span><span class="n">g_h</span><span class="p">)</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Download-and-load-pretrained-weights">
<h3>Download and load pretrained weights<a class="headerlink" href="#Download-and-load-pretrained-weights" title="Link to this heading"></a></h3>
<p>On the projects <a class="reference external" href="https://osf.io/pf4u5/">OSF</a> page the authors published pretrained weights for the RNN they used. The RNN was trained for 20-way classification using a cross-entropy loss. They used the Adam optimizer for training, with a batch size of 32, and learning rate of <span class="math notranslate nohighlight">\(10^{−4}\)</span>. The network was trained for 300.000 iterations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># get weights from OSF</span>
<span class="c1"># first set of weights</span>
<span class="o">%%</span><span class="n">capture</span>

<span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">c</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">osf</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">wxmkv</span><span class="o">/</span><span class="n">download</span><span class="o">/</span> <span class="o">-</span><span class="n">O</span> <span class="n">rnn_bglt_0111_t_4_num_1</span><span class="o">.</span><span class="n">pth</span>
<span class="c1"># second set of weights</span>
<span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">c</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">osf</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="mi">98</span><span class="n">tgk</span><span class="o">/</span><span class="n">download</span> <span class="o">-</span><span class="n">O</span> <span class="n">rnn_bglt_1011_t_4_num_1</span><span class="o">.</span><span class="n">pth</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load weights into the initialized RNN model</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">net_save_str</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
<span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RNNet_all_fbr(
  (conv1): Conv2d(1, 8, kernel_size=(5, 5), stride=(1, 1))
  (pool): MaxPool2d(kernel_size=3, stride=3, padding=0, dilation=1, ceil_mode=False)
  (conv2): Conv2d(8, 16, kernel_size=(5, 5), stride=(1, 1))
  (fc1): Linear(in_features=1296, out_features=128, bias=True)
  (fc2): Linear(in_features=512, out_features=20, bias=True)
  (dropout): Dropout(p=0.5, inplace=False)
  (c1xb): ConvTranspose2d(8, 1, kernel_size=(7, 7), stride=(3, 3))
  (c2xb): ConvTranspose2d(16, 1, kernel_size=(20, 20), stride=(10, 10))
  (fc1xb): Linear(in_features=128, out_features=10000, bias=True)
  (c1c1b): Conv2d(8, 8, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
  (c2c1b): ConvTranspose2d(16, 8, kernel_size=(16, 16), stride=(10, 10))
  (fc1c1b): Linear(in_features=128, out_features=73728, bias=True)
  (c2c2b): Conv2d(16, 16, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
  (fc1c2b): Linear(in_features=128, out_features=12544, bias=True)
  (fc1fc1b): Linear(in_features=128, out_features=128, bias=True)
  (c1xg): ConvTranspose2d(8, 1, kernel_size=(7, 7), stride=(3, 3))
  (c2xg): ConvTranspose2d(16, 1, kernel_size=(20, 20), stride=(10, 10))
  (fc1xg): Linear(in_features=128, out_features=10000, bias=True)
  (c1c1g): Conv2d(8, 8, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
  (c2c1g): ConvTranspose2d(16, 8, kernel_size=(16, 16), stride=(10, 10))
  (fc1c1g): Linear(in_features=128, out_features=73728, bias=True)
  (c2c2g): Conv2d(16, 16, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
  (fc1c2g): Linear(in_features=128, out_features=12544, bias=True)
  (fc1fc1g): Linear(in_features=128, out_features=128, bias=True)
)
</pre></div></div>
</div>
</section>
</section>
<section id="Running-the-Model">
<h2>Running the Model<a class="headerlink" href="#Running-the-Model" title="Link to this heading"></a></h2>
<p>We start by again generating images, and now feed them as input to the model. The output after <code class="docutils literal notranslate"><span class="pre">t_steps</span></code> number of timesteps, as well as intermediate results, are saved in <code class="docutils literal notranslate"><span class="pre">outputs</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create cluttered images</span>
<span class="n">img_num</span> <span class="o">=</span> <span class="mi">5</span>        <span class="c1"># number of images to create</span>
<span class="n">img_set</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># set used (0 train, 1 val, 2 test)</span>

<span class="c1"># create cluttered images using the authors helper function gen_images</span>
<span class="n">inputs_v</span><span class="p">,</span><span class="n">inputs_v_c</span><span class="p">,</span><span class="n">labels_v</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">generate_images</span><span class="p">(</span><span class="n">img_num</span><span class="p">,</span> <span class="n">img_set</span><span class="p">)</span>
<span class="n">inputs_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">inputs_v</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<span class="n">inputs_v_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">inputs_v_c</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

<span class="c1"># pass it to the network</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
  <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
  <span class="n">outputs</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">out_fbr_comb</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">inputs_v</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<br/></pre></div>
</div>
</div>
<section id="QUESTION-2">
<h3><strong>QUESTION 2</strong><a class="headerlink" href="#QUESTION-2" title="Link to this heading"></a></h3>
<ol class="loweralpha simple">
<li><p>Verify that the weights you just downloaded define a pretty good network to classify images. Report the accuracy on a sample of +-50 images. Find an example that is misclassified, and include the image in your report together with several correctly classified images. (You may find the next two code blocks useful).</p></li>
<li><p>How would you define a control condition against which you could compare the accuracy you just calculated?</p></li>
</ol>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># print true label and predicted label for each of the input images in inputs_v</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img_num</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;True label:&#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labels_v</span><span class="p">[</span><span class="n">i</span><span class="p">,:])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span>
        <span class="s1">&#39;; Predicted label:&#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Index: 0 True label: Shirt ; Predicted label: Pullover
Index: 1 True label: 2 ; Predicted label: 2
Index: 2 True label: 2 ; Predicted label: 9
Index: 3 True label: 8 ; Predicted label: 9
Index: 4 True label: Coat ; Predicted label: Coat
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># initiate plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="c1"># plot images</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
    <span class="c1"># plot image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">inputs_v</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

    <span class="c1"># extract ground truth label</span>
    <span class="n">img_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">labels_v</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ground truth: &#39;</span> <span class="o">+</span> <span class="n">class_names</span><span class="p">[</span><span class="n">img_idx</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># increment count</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># show plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_37_0.png" src="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_37_0.png" />
</div>
</div>
</section>
</section>
<section id="Recurrent-connections">
<h2>Recurrent connections<a class="headerlink" href="#Recurrent-connections" title="Link to this heading"></a></h2>
<p>In this part of the tutorial, we follow the authors in how they analyzed the networks’ activations to shed light on whether or not auxiliary variables get extracted and represented in the RNN or if they are suppressed. This will help us understand the information flow in the network, as well as the network performance.</p>
<p>First, like the authors, we will study the presence of activation patterns across layers and timesteps. Second, once we can formulate some hypotheses on the role of the recurrent connections, we will investigate what happens if we perturbed the input data (or parts of the network) in specific way to test these hypotheses.</p>
<section id="QUESTION-3">
<h3><strong>QUESTION 3</strong><a class="headerlink" href="#QUESTION-3" title="Link to this heading"></a></h3>
<p>Look back at the network architecture in the Figure above. Can you infer the number of lateral and top-down connections? What is the purpose of recurrent connections?</p>
</section>
</section>
<section id="Studying-category-orthogonal-information-flow">
<h2>Studying category-orthogonal information flow<a class="headerlink" href="#Studying-category-orthogonal-information-flow" title="Link to this heading"></a></h2>
<p>The hypothesis of the authors is that the recurrent connections play a big role in allowing the network to focus on information that is relevant for category-membership, while suppressing information that is orthogonal to category-membership. In the following code block, you can plot the activations across layers over time to get an idea about how the network represents the input and how those representations change.</p>
<p>Run this code for different input images (by changing <span class="math notranslate nohighlight">\(i\)</span>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;True label:&#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labels_v</span><span class="p">[</span><span class="n">i</span><span class="p">,:])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;; Predicted label:&#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_steps</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">t_steps</span><span class="p">,</span><span class="n">t_steps</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True label: 2 ; Predicted label: 9
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_43_1.png" src="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_43_1.png" />
</div>
</div>
<p>Now, let’s have a look at many input images at once, and the effect of the recurrent information flow for all timesteps:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;True label:&#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labels_v</span><span class="p">[</span><span class="n">i</span><span class="p">,:])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;; Predicted label:&#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_steps</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">t_steps</span><span class="p">,(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">t_steps</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True label: Shirt ; Predicted label: Pullover
True label: 2 ; Predicted label: 2
True label: 2 ; Predicted label: 9
True label: 8 ; Predicted label: 9
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_45_1.png" src="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_45_1.png" />
</div>
</div>
<section id="QUESTION-4">
<h3><strong>QUESTION 4</strong><a class="headerlink" href="#QUESTION-4" title="Link to this heading"></a></h3>
<p>Briefly describe how the network maintains object and orthogonal information over time and how this relates to the lateral/top-down connections.</p>
<p>Now let’s have a look at how information is maintained. More precisely, we will look at both the auxiliary variables as well as the category information. To test for the presence of category-orthogonal information in the RNN activation patterns across layers and timesteps, the authors trained linear diagnostic readouts (i.e., classifiers) targeting auxiliary variables (i.e. predicting the location, scale, and orientation of the object), in addition to determining the presence of category
information in the network activations. Here is how to plot part of the results from this analysis:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dec_acc1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="n">t_steps</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">out_acc1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">fbr_accs_all_comb1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="n">t_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="k">for</span> <span class="n">net_num1</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">dec_accs_str</span> <span class="o">=</span> <span class="s1">&#39;svrhm21_RNN_explain/analyses/&#39;</span><span class="o">+</span><span class="s1">&#39;dec_acc&#39;</span><span class="o">+</span><span class="s1">&#39;rnn_bglt_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">b_h</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">g_h</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">l_h</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t_h</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_t_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t_steps</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_num_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">net_num1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dec_accs_str</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">dec_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">out_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">fbr_accs_all_comb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">dec_acc1</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,:,</span><span class="n">net_num1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dec_acc</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,:,:],</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">dec_acc1</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,:,</span><span class="n">net_num1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dec_acc</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,:,:],</span><span class="mi">4</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dec_acc1</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">:,:,</span><span class="n">net_num1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dec_acc</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:,:,:],</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">out_acc1</span><span class="p">[</span><span class="n">net_num1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">out_acc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fbr_accs_all_comb1</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">net_num1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fbr_accs_all_comb</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">,:],</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">fbr_accs_all_comb1</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">,</span><span class="n">net_num1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fbr_accs_all_comb</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,:],</span><span class="mi">4</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">fbr_accs_all_comb1</span><span class="p">[:,:,:,</span><span class="mi">2</span><span class="p">:,</span><span class="n">net_num1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fbr_accs_all_comb</span><span class="p">[:,:,:,</span><span class="mi">3</span><span class="p">:,:],</span><span class="mi">4</span><span class="p">)</span>

<span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Category&#39;</span><span class="p">,</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span><span class="s1">&#39;Scale&#39;</span><span class="p">,</span><span class="s1">&#39;Orientation&#39;</span><span class="p">]</span>
<span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Input&#39;</span><span class="p">,</span><span class="s1">&#39;Conv1&#39;</span><span class="p">,</span><span class="s1">&#39;Conv2&#39;</span><span class="p">,</span><span class="s1">&#39;FC&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mf">4.2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_steps</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dec_acc1</span><span class="p">[</span><span class="n">j</span><span class="p">,:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,:],</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dec_acc1</span><span class="p">[</span><span class="n">j</span><span class="p">,:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,:])</span><span class="o">*</span><span class="mf">100.</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_steps</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">ci</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">ci</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_steps</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dec_acc1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">,:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,:],</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_steps</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Decoding accuracy&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">var_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Timestep&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output category accuracies: &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">out_acc1</span><span class="p">,</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Auxiliary variable avg. decoding through time: &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dec_acc1</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,:],</span><span class="mi">3</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Auxiliary variable avg. decoding through layer depth: &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dec_acc1</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,:],</span><span class="mi">3</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Output category accuracies:  0.81226
Auxiliary variable avg. decoding through time:  [0.65223333 0.730225   0.82524583 0.84927083]
Auxiliary variable avg. decoding through layer depth:  [0.70119167 0.7465125  0.81060833 0.7986625 ]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_48_1.png" src="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_48_1.png" />
</div>
</div>
</section>
<section id="QUESTION-5">
<h3><strong>QUESTION 5</strong><a class="headerlink" href="#QUESTION-5" title="Link to this heading"></a></h3>
<ol class="loweralpha simple">
<li><p>Plot the decoding accuracy for the auxiliary variables (i.e., location, scale, orientation) as well, similar to the plot above.</p></li>
<li><p>How would you interpret the plots you obtained? How is information about auxiliary variables contributing to the decoding accuracy?</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span><span class="s1">&#39;Scale&#39;</span><span class="p">,</span><span class="s1">&#39;Orientation&#39;</span><span class="p">]</span>

<span class="c1"># please write the code below</span>
<span class="c1"># plt.figure(figsize=(...)</span>

<span class="c1"># for i in np.arange(...):</span>
<span class="c1">#     plt.subplot(...)</span>

<span class="c1"># ...</span>


<span class="c1">############################</span>
</pre></div>
</div>
</div>
<p><strong>Paper Figure 3 (A)</strong></p>
</section>
</section>
<section id="Perturbation-analysis">
<h2>Perturbation analysis<a class="headerlink" href="#Perturbation-analysis" title="Link to this heading"></a></h2>
<p>Next, we ask if the succesful decoding of auxiliary variables from recurrent information flow also functionally contributes. Why is it important to ask this question? When we are able to <em>decode</em> one property, this only means that the network is <em>representing</em> that property. However, the fact that the property is represented doesn’t necessarily mean that it’s being <em>used</em> by the network to perform the task it is trained on.</p>
<p>How can we show that the auxiliary variables are not only represented but also useful for the task? We try to <em>perturb</em> (i.e., corrupt) the representation of these variables in different parts of the networks and then we check whether these perturbations affect performance (i.e., classification accuracy). The authors perturb the representations by replacing the feedbacks to some layers at some timepoints with “wrong” feedbacks that belong to <em>systematically</em> perturbed images. What does
‘systematically’ mean here? Well, if we do a ‘random’ perturbation, then we can’t really say whether a change in performance can be attibuted to a specific variable (e.g., Location). To be able to do so, we must perturb the image in a systematic way, i.e., so that only the target variable changes.</p>
<p>The authors indeed experiment with <em>systematic</em> perturbations and with <em>random</em> perturbations (which serve as a control condition). If the <em>systematic</em> perturbations affect performance more than <em>random</em> perturbations, then it means that the perturbed variable was actually useful for the network to correctly classify images. Please have a look at the overview of this part of the study below.</p>
<p><img alt="Figure 4" src="https://github.com/clclab/ANCM/blob/main/book/img/04_lab_paper_figure4.png?raw=1" /></p>
<p>We’ll be looking at the accuracy values obtained by the authors on uncorrupted images, corrupted images, and control images. Here’s how we can access those values:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net_num</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">out_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;svrhm21_RNN_explain/analyses/fb_perturb-rnn_bglt_0111_t_4_num_</span><span class="si">{</span><span class="n">net_num</span><span class="si">}</span><span class="s1">.npy&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_str</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">original_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">perturbed_accuracies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s inspect the arrays one by one:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">original_accuracy</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(5, 1)
</pre></div></div>
</div>
<p>Here, we have 5 different accuracy values because they correspond to 5 different repetitions of the experiment.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">perturbed_accuracies</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(6, 2, 4, 3, 5)
</pre></div></div>
</div>
<p>Let’s break down the dimensions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">6</span></code> is the number of different perturbations. Here, the index <code class="docutils literal notranslate"><span class="pre">0</span></code> corresponds to a change on the x location of the image, <code class="docutils literal notranslate"><span class="pre">1</span></code> to a change on the y location, <code class="docutils literal notranslate"><span class="pre">2</span></code> to a rotation, <code class="docutils literal notranslate"><span class="pre">3</span></code> to a change in size, <code class="docutils literal notranslate"><span class="pre">4</span></code> to a change in category (within supercategories, i.e, a piece of clothing is replaced with another piece of clothing), and <code class="docutils literal notranslate"><span class="pre">5</span></code> to a change between categories (i.e, a piece of clothing is replaced with a digit);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2</span></code> indicates the perturbation condition. Here, the index 0 refers to the systematic perturbation, while 1 to the random one;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">4</span></code> is the number of timesteps;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">3</span></code> is the number of feedbacks between layers;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">5</span></code> is, again, the number of repetitions of the experiment.</p></li>
</ul>
<p>We can get a more precise idea about how the different perturbations look like by plotting a few perturbed images:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">svrhm21_RNN_explain.RNN_perturb</span> <span class="kn">import</span> <span class="n">gen_images</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 9.91M/9.91M [00:00&lt;00:00, 33.5MB/s]
100%|██████████| 28.9k/28.9k [00:00&lt;00:00, 1.07MB/s]
100%|██████████| 1.65M/1.65M [00:00&lt;00:00, 9.38MB/s]
100%|██████████| 4.54k/4.54k [00:00&lt;00:00, 7.33MB/s]
100%|██████████| 26.4M/26.4M [00:01&lt;00:00, 16.0MB/s]
100%|██████████| 29.5k/29.5k [00:00&lt;00:00, 270kB/s]
100%|██████████| 4.42M/4.42M [00:00&lt;00:00, 5.03MB/s]
100%|██████████| 5.15k/5.15k [00:00&lt;00:00, 9.86MB/s]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n_ex</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">imgs_h</span><span class="p">,</span><span class="n">imgs_h_xswap</span><span class="p">,</span><span class="n">imgs_h_yswap</span><span class="p">,</span><span class="n">imgs_h_rotswap</span><span class="p">,</span><span class="n">imgs_h_sizeswap</span><span class="p">,</span><span class="n">imgs_h_catswap_w</span><span class="p">,</span><span class="n">imgs_h_catswap_b</span><span class="p">,</span><span class="n">labs_h</span><span class="p">,</span><span class="n">pos_x_h</span><span class="p">,</span><span class="n">pos_y_h</span><span class="p">,</span><span class="n">size_h</span><span class="p">,</span><span class="n">rot_h</span> <span class="o">=</span> <span class="n">gen_images</span><span class="p">(</span><span class="n">n_ex</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">perturbed_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">imgs_h</span><span class="p">,</span><span class="n">imgs_h_xswap</span><span class="p">,</span><span class="n">imgs_h_yswap</span><span class="p">,</span><span class="n">imgs_h_rotswap</span><span class="p">,</span><span class="n">imgs_h_sizeswap</span><span class="p">,</span><span class="n">imgs_h_catswap_w</span><span class="p">,</span><span class="n">imgs_h_catswap_b</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="s1">&#39;Y loc&#39;</span><span class="p">,</span> <span class="s1">&#39;X loc&#39;</span><span class="p">,</span> <span class="s1">&#39;Rotation&#39;</span><span class="p">,</span> <span class="s1">&#39;Size&#39;</span><span class="p">,</span> <span class="s1">&#39;Category within&#39;</span><span class="p">,</span> <span class="s1">&#39;Category between&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>

    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">perturbed_images</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_65_0.png" src="../_images/week_4_4_Vision%2C_Convolutions_and_Recurrence_65_0.png" />
</div>
</div>
<section id="QUESTION-6">
<h3><strong>QUESTION 6</strong><a class="headerlink" href="#QUESTION-6" title="Link to this heading"></a></h3>
<p>Select one or more types of perturbations and create plots that show the average functional importance of the perturbation across layers and timesteps. In the paper, functional importance was defined as:</p>
<p><span class="math notranslate nohighlight">\(\frac{Accuracy_{control} - Accuracy_{systematic}}{Accuracy_{original}}\)</span></p>
<p>Your plot should roughly contain the same information that is plotted in Figure 4. However, Figure 4 aggregates multiple manipulations under the labels <em>Location</em> and <em>Category</em> (see the paper for the details). Here, you are not required to aggregate the manipulations and, instead,you are encouraged to explore them separately. Try to also aggregate the information in the way that seems clearer to you instead of simply replicating the arrangement adopted in Figure 4.</p>
<p><em>Bonus</em>: Results in the original paper are not only averaged across repetitions, but also across 5 initialisations of the same network. If you want to reproduce the results more closely, you can access the accuracy values from the other networks by editing the <code class="docutils literal notranslate"><span class="pre">net_num</span></code> parameter in the following path:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>out_str = f&#39;svrhm21_RNN_explain/analyses/fb_perturb-rnn_bglt_0111_t_4_num_{net_num}.npy&#39;
</pre></div>
</div>
</section>
<section id="QUESTION-7">
<h3><strong>QUESTION 7</strong><a class="headerlink" href="#QUESTION-7" title="Link to this heading"></a></h3>
<p>Consider how the images were altered in terms of perturbations and clutter. Do you think the main findings from this work would generalise to more naturalistic images? Briefly elaborate on why you think this is/in not the case.</p>
<p>Plase include your answers to all questions from this notebook in a separate PDF. There is no space limit, but please do your best to keep your answers clear and concise.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../week_3/3_IRT_Stan.html" class="btn btn-neutral float-left" title="3 - Item Response Theory with Stan" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../project_ideas.html" class="btn btn-neutral float-right" title="Project Inspiration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Anna Bavaresco 2025.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>